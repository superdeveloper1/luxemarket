<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quick Fix - LuxeMarket</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen p-4">
    <div class="max-w-4xl mx-auto">
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h1 class="text-3xl font-bold text-gray-900 mb-6">LuxeMarket Quick Fix & Test</h1>
            
            <!-- Diagnostic Section -->
            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
                <h2 class="text-lg font-semibold text-yellow-800 mb-3">üîß System Diagnostics</h2>
                <div id="diagnostics" class="space-y-2 text-sm">
                    <div>Loading diagnostics...</div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <button onclick="clearAllData()" class="bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-4 rounded-lg"></button>
                    üóëÔ∏è Clear All Data
                </button>
                <button onclick="addTestProduct()" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg">
                    ‚ûï Add Test Product
                </button>
                <button onclick="goToApp()" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg">
                    üöÄ Go to App
                </button>
            </div>

            <!-- Add Product Form -->
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                <h2 class="text-lg font-semibold text-blue-800 mb-3">Add Product with Size Selection</h2>
                <form id="productForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input type="text" id="name" placeholder="Product Name" required class="px-3 py-2 border rounded-md">
                    <input type="number" id="price" placeholder="Price" step="0.01" required class="px-3 py-2 border rounded-md">
                    
                    <select id="category" required class="px-3 py-2 border rounded-md">
                        <option value="">Select Category</option>
                        <option value="Fashion">Fashion (Clothing)</option>
                        <option value="Shoes">Shoes</option>
                        <option value="Electronics">Electronics</option>
                    </select>
                    
                    <input type="url" id="image" placeholder="Image URL" required class="px-3 py-2 border rounded-md">
                    
                    <input type="text" id="colors" placeholder="Colors: Red, Blue, Black" class="px-3 py-2 border rounded-md">
                    <input type="text" id="sizes" placeholder="Sizes: XS,S,M,L,XL or 7,8,9,10,11" class="px-3 py-2 border rounded-md">
                    
                    <textarea id="description" placeholder="Description" class="md:col-span-2 px-3 py-2 border rounded-md" rows="2"></textarea>
                    
                    <button type="submit" class="md:col-span-2 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md">
                        Add Product
                    </button>
                </form>
            </div>

            <!-- Status Messages -->
            <div id="status" class="hidden p-4 rounded-md mb-4"></div>

            <!-- Products Display -->
            <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                <h2 class="text-lg font-semibold text-gray-800 mb-3">Current Products</h2>
                <div id="productsList">Loading...</div>
            </div>
        </div>
    </div>

    <script>
        // Enhanced ProductManager with better error handling
        const PRODUCT_STORAGE_KEY = 'luxemarket_products';
        const CATEGORY_STORAGE_KEY = 'luxemarket_categories';
        const CURRENT_DATA_VERSION = 'v1.9';

        const ProductManager = {
            init: () => {
                try {
                    // Test localStorage availability
                    const testKey = 'test_storage';
                    localStorage.setItem(testKey, 'test');
                    localStorage.removeItem(testKey);
                    
                    const storedVersion = localStorage.getItem('luxemarket_data_version');
                    if (!localStorage.getItem(PRODUCT_STORAGE_KEY) || storedVersion !== CURRENT_DATA_VERSION) {
                        localStorage.setItem(PRODUCT_STORAGE_KEY, JSON.stringify([]));
                        localStorage.setItem(CATEGORY_STORAGE_KEY, JSON.stringify(['Electronics', 'Fashion', 'Shoes', 'Furniture']));
                        localStorage.setItem('luxemarket_data_version', CURRENT_DATA_VERSION);
                        console.log('‚úÖ ProductManager initialized with version', CURRENT_DATA_VERSION);
                    }
                    return true;
                } catch (error) {
                    console.error('‚ùå ProductManager init failed:', error);
                    return false;
                }
            },

            getAll: () => {
                try {
                    ProductManager.init();
                    const data = localStorage.getItem(PRODUCT_STORAGE_KEY);
                    return data ? JSON.parse(data) : [];
                } catch (error) {
                    console.error('‚ùå Error getting products:', error);
                    return [];
                }
            },

            save: (product) => {
                try {
                    const products = ProductManager.getAll();
                    const newId = Math.max(...products.map(p => Number(p.id) || 0), 0) + 1;
                    
                    const newProduct = {
                        ...product,
                        id: newId,
                        rating: 4.5,
                        reviews: Math.floor(Math.random() * 50) + 10,
                        timestamp: new Date().toISOString()
                    };
                    
                    products.push(newProduct);
                    localStorage.setItem(PRODUCT_STORAGE_KEY, JSON.stringify(products));
                    
                    // Verify save worked
                    const verification = ProductManager.getAll();
                    if (verification.length === products.length) {
                        console.log('‚úÖ Product saved successfully:', newProduct.name);
                        return newProduct;
                    } else {
                        throw new Error('Save verification failed');
                    }
                } catch (error) {
                    console.error('‚ùå Error saving product:', error);
                    throw error;
                }
            },

            delete: (id) => {
                try {
                    const products = ProductManager.getAll();
                    const filtered = products.filter(p => p.id !== Number(id));
                    localStorage.setItem(PRODUCT_STORAGE_KEY, JSON.stringify(filtered));
                    console.log('‚úÖ Product deleted:', id);
                } catch (error) {
                    console.error('‚ùå Error deleting product:', error);
                }
            },

            clear: () => {
                try {
                    localStorage.removeItem(PRODUCT_STORAGE_KEY);
                    localStorage.removeItem(CATEGORY_STORAGE_KEY);
                    localStorage.removeItem('luxemarket_data_version');
                    localStorage.removeItem('luxemarket_cart');
                    console.log('‚úÖ All data cleared');
                } catch (error) {
                    console.error('‚ùå Error clearing data:', error);
                }
            }
        };

        // Utility functions
        function showStatus(message, type = 'success') {
            const status = document.getElementById('status');
            status.className = `p-4 rounded-md mb-4 ${type === 'success' ? 'bg-green-100 text-green-800 border border-green-200' : 'bg-red-100 text-red-800 border border-red-200'}`;
            status.textContent = message;
            status.classList.remove('hidden');
            setTimeout(() => status.classList.add('hidden'), 5000);
        }

        function parseColors(colorString) {
            if (!colorString) return [];
            const colorMap = {
                'red': '#EF4444', 'blue': '#3B82F6', 'green': '#10B981', 'black': '#000000',
                'white': '#FFFFFF', 'gray': '#6B7280', 'yellow': '#F59E0B', 'purple': '#8B5CF6',
                'pink': '#EC4899', 'brown': '#8B4513', 'navy': '#1E3A8A', 'orange': '#F97316'
            };
            return colorString.split(',').map(c => {
                const name = c.trim();
                return { name, hex: colorMap[name.toLowerCase()] || '#6B7280' };
            });
        }

        function parseSizes(sizeString) {
            return sizeString ? sizeString.split(',').map(s => s.trim()).filter(s => s) : [];
        }

        // Main functions
        function runDiagnostics() {
            const diagnostics = document.getElementById('diagnostics');
            const results = [];

            // Test localStorage
            try {
                localStorage.setItem('test', 'test');
                localStorage.removeItem('test');
                results.push('‚úÖ localStorage: Working');
            } catch (e) {
                results.push('‚ùå localStorage: Failed - ' + e.message);
            }

            // Test ProductManager
            try {
                const initResult = ProductManager.init();
                results.push(initResult ? '‚úÖ ProductManager: Initialized' : '‚ùå ProductManager: Failed to initialize');
            } catch (e) {
                results.push('‚ùå ProductManager: Error - ' + e.message);
            }

            // Check current data
            try {
                const products = ProductManager.getAll();
                results.push(`üìä Current products: ${products.length}`);
                const version = localStorage.getItem('luxemarket_data_version');
                results.push(`üìã Data version: ${version || 'none'}`);
            } catch (e) {
                results.push('‚ùå Data check failed: ' + e.message);
            }

            // Browser info
            results.push(`üåê Browser: ${navigator.userAgent.split(' ').pop()}`);
            results.push(`üìç Protocol: ${window.location.protocol}`);
            results.push(`üîó Host: ${window.location.host || 'local file'}`);

            diagnostics.innerHTML = results.map(r => `<div>${r}</div>`).join('');
        }

        function clearAllData() {
            if (confirm('Clear all product data? This cannot be undone.')) {
                ProductManager.clear();
                showStatus('All data cleared successfully!');
                loadProducts();
                runDiagnostics();
            }
        }

        function addTestProduct() {
            try {
                const testProduct = {
                    name: "Test Running Shoes",
                    price: 129.99,
                    category: "Shoes",
                    description: "Test product with enhanced size selection",
                    image: "https://images.unsplash.com/photo-1542291026-7eec264c27ff?w=300",
                    colors: [
                        { name: "Black", hex: "#000000" },
                        { name: "White", hex: "#FFFFFF" },
                        { name: "Red", hex: "#EF4444" }
                    ],
                    sizes: ["7", "8", "9", "10", "11", "12"]
                };

                const saved = ProductManager.save(testProduct);
                showStatus(`Test product "${saved.name}" added successfully!`);
                loadProducts();
            } catch (error) {
                showStatus('Error adding test product: ' + error.message, 'error');
            }
        }

        function loadProducts() {
            try {
                const products = ProductManager.getAll();
                const container = document.getElementById('productsList');
                
                if (products.length === 0) {
                    container.innerHTML = '<p class="text-gray-500">No products found. Add some products above!</p>';
                    return;
                }

                container.innerHTML = products.map(product => `
                    <div class="bg-white p-4 rounded-md border mb-2">
                        <div class="flex justify-between items-start">
                            <div class="flex items-center space-x-4">
                                <img src="${product.image}" alt="${product.name}" class="w-16 h-16 object-cover rounded" onerror="this.src='https://via.placeholder.com/64'">
                                <div>
                                    <h3 class="font-semibold">${product.name}</h3>
                                    <p class="text-gray-600">$${product.price} ‚Ä¢ ${product.category}</p>
                                    ${product.colors && product.colors.length > 0 ? `<p class="text-sm text-gray-500">Colors: ${product.colors.map(c => c.name).join(', ')}</p>` : ''}
                                    ${product.sizes && product.sizes.length > 0 ? `<p class="text-sm text-gray-500">Sizes: ${product.sizes.join(', ')}</p>` : ''}
                                    <p class="text-xs text-gray-400">ID: ${product.id}</p>
                                </div>
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="viewProduct(${product.id})" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm">
                                    View
                                </button>
                                <button onclick="deleteProduct(${product.id})" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm">
                                    Delete
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                document.getElementById('productsList').innerHTML = `<p class="text-red-500">Error loading products: ${error.message}</p>`;
            }
        }

        function deleteProduct(id) {
            if (confirm('Delete this product?')) {
                ProductManager.delete(id);
                loadProducts();
                showStatus('Product deleted!');
            }
        }

        function viewProduct(id) {
            window.open(`product.html?id=${id}`, '_blank');
        }

        function goToApp() {
            window.open('index.html', '_blank');
        }

        // Form submission
        document.getElementById('productForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            try {
                const product = {
                    name: document.getElementById('name').value,
                    price: parseFloat(document.getElementById('price').value),
                    category: document.getElementById('category').value,
                    image: document.getElementById('image').value,
                    description: document.getElementById('description').value,
                    colors: parseColors(document.getElementById('colors').value),
                    sizes: parseSizes(document.getElementById('sizes').value)
                };

                const saved = ProductManager.save(product);
                showStatus(`Product "${saved.name}" added successfully! ID: ${saved.id}`);
                e.target.reset();
                loadProducts();
            } catch (error) {
                showStatus('Error adding product: ' + error.message, 'error');
            }
        });

        // Initialize on load
        document.addEventListener('DOMContentLoaded', function() {
            runDiagnostics();
            loadProducts();
        });
    </script>
</body>
</html>